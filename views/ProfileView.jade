extends layout
block content
    link(rel='stylesheet', href='stylesheets/jquery-ui.css')
    link(rel='stylesheet', href='stylesheets/jquery.tagit.css')
    div
        div
            if (owner)
                p Hello #{user.username}
            p Search link
            a(href="/finder") Search

        div#photo
            img#avatar(src='#{user.photo}')

        div#skills(style="color:#c4c4c4;font-size: 14px;font-family: 'Proxima Nova';")
            p User's skills:
            if user.skills
                for object in user.skills
                    for points, skill in object
                        p.userSkill #{skill} - #{points}
        if (owner)
            div#skillEditor
                input#tags(type='text')
                button#addTags(type="button") Save skills

        div#hours
            p User's available hours:
            if (owner)
                input#addHour(type='button', value='Add date')
            if user.hours
                for hour, day in user.hours
                    for time in hour
                        div.availableHour
                            select
                                option #{day}
                            select
                                option #{time}


        if (owner)
            div#hourEditor
                button#saveHours(type="button") Save hours

        if !(owner)
            div#inviteCreator
                button#createInvite(type='button')


block script
    script(src='/components/jquery/jquery.min.js')
    script(src='/js/underscore.js')
    script(src='/js/jquery-ui.js')
    script(src='/js/tagit.js')

    if (owner)
        script(src='js/dropzone.js')
        :coffeescript
            $('#avatar').dropzone {url: '/user/photo',
            init: ->
                this.on 'success', (file, url) ->
                    if url.status == 200
                        $('#avatar').attr 'src', url.url
            }

    if !(owner)
        :coffeescript
            document.getElementById('createInvite').onclick = (e) ->
                $('#createInvite').fadeOut()
                textarea = document.createElement('textarea')
                textarea.setAttribute 'id', 'message'
                $('#inviteCreator').append textarea
                button = document.createElement('button')
                button.setAttribute 'id', 'sendInvite'
                $('#inviteCreator').append button

            document.getElementById('sendInvite').onclick = (e) ->
                console.log $('#message').val()

    :coffeescript

        $.get '/tags', (res) ->
            $('#tags').tagit
                fieldName: 'skill',
                availableTags: res.tags,
                allowSpaces: true,

        days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday']
        hours = ['1:00', '2:00', '3:00', '4:00', '5:00', '6:00', '7:00', '8:00', '9:00', '10:00', '11:00', '12:00']
        document.getElementById('addHour').onclick = (e) ->
            newDiv = document.createElement 'div'
            $(newDiv).attr 'class', 'availableHour'
            $('#hours').append newDiv
            newSelect = document.createElement 'select'
            for day in days
                option = new Option()
                option.text = option.value = day
                newSelect.options.add option
            $('.availableHour').last().append newSelect
            newSelect = document.createElement 'select'
            for hour in hours
                option = new Option()
                option.text = option.value = hour + ' AM'
                newSelect.options.add option
            for hour in hours
                option = new Option()
                option.text = option.value = hour + ' PM'
                newSelect.options.add option
            $('.availableHour').last().append newSelect


        document.getElementById('addTags').onclick = (e) ->
            tags = $('.tagit-label').map(->
                $(this).text()
            ).get()

            currentTags = $('.userSkill').map(->
                $(this).text().split('-')[0].replace RegExp(" ", "g"), ""
            ).get()
            tags = _.difference tags, currentTags
            tags = (JSON.parse('{\"' + tag + '\": 5}') for tag in tags)

            if tags.length > 0
                json = {}
                json['skills'] = tags
                $.post '/user/addskill', json, (res) ->
                    if res == 'OK' or res == 200
                        $('.tagit-label').remove() #find better fix
                        tags.forEach (element) ->
                            skill = Object.keys(element)[0]
                            $('#skills').append '<p class=\'userSkill\'>' + skill + ' - ' + element[skill] + '</p>'
            else
                $('.tagit-label').remove()

        document.getElementById('saveHours').onclick = (e) ->
            hours = {}
            for div in $('.availableHour')
                console.log div
                contents = $(div)
                day = $(contents).children().first().val()
                hour = $(contents).children().last().val()
                console.log day, hour
                if _.has hours, day
                    console.log 'has it'
                    hours[day].push hour
                    hours[day] = _.uniq hours[day]
                else
                    console.log 'doesnt'
                    hours[day] = [hour]

            json = {}
            json['hours'] = hours
            console.log hours
            $.post '/user/sethours', json, (res) ->
                console.log res
                if res == 'OK' or res == 200
                    alert 'Saved'
